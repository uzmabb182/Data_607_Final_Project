---
title: "Data 607 - Final Project"
output: html_document
---

### Project Proposal:

Source of motivation for the final project: Community Health and Economic Prosperity
The Problem, the Causes, the Opportunities, and
the Solutionsâ€”At a Glance

https://www.hhs.gov/sites/default/files/chep-sgr-at-a-glance.pdf


NJ County level 2012 Diabetes Prevalence Data (CDC):

https://www.openintro.org/data/index.php?data=diabetes.prev

 
Web Scraping list of fips code: https://en.wikipedia.org/wiki/List_of_United_States_FIPS_codes_by_county


API Call to census five years data:

https://api.census.gov/data/2010/acs/acs1?get=NAME,B01001_001E&for=county:*




### Importing Libraries

```{r}
library(tidycensus)
library(tidyverse)
library(dplyr)
library(plotly)
library(tidyr)
library(stringr)
library(rvest)

```

### API Call for census data for the year 2015-19

```{r}
Sys.setenv(census_api_key = "f7ce5a76ddf2088c73fda9c0a87410995cebbffa")
Sys.getenv("census_api_key")
```


### Access the API key
### Save the Census API key in the environmental variable.
```{r}
#census_api_key("YOUR KEY GOES HERE", install = TRUE)
```


```{r}
Sys.getenv("census_api_key")
```

### Fetching Census Data for the year 2010

```{r}
# https://api.census.gov/data/2010/acs/acs1?get=NAME,B01001_001E&for=county:*

nj_wide <- get_acs(
  geography = "county",
  state = "NJ",
  variables = c(population = "B01003_001E",
                median_age = "B01002_001E",
                household_income = "B19013_001E",
                per_capita_income = "B19301_001E",
                poverty_count = "B17001_002E"
                ),
  output = "wide",
  year = 2010
)

head(nj_wide)

```

### Removing the string 'County' from NAME column

```{r}
nj_wide$NAME<-gsub(" County, New Jersey","",as.character(nj_wide$NAME))

head(nj_wide)
```

### Renaming column name

```{r}
nj_wide <- nj_wide %>%
  rename(county = NAME
         )
head(nj_wide)
```


### Selecting the column of interest

```{r}
census_df <- select(nj_wide, county, population, median_age, household_income, per_capita_income, poverty_count)

head(census_df)
```


### Checking the working directory path and exporting data frame into a CSV file

```{r}
# Get working directory path
path <- getwd()

path

```


### Web Scraping Counties fips code


### Generate the html source code by calling the read_html function

```{r}

webpage <- read_html("https://en.wikipedia.org/wiki/List_of_United_States_FIPS_codes_by_county")

tbls <- html_nodes(webpage, "table")

head(tbls)
```

### Calling html_nodes function with CSS Selector and generating the table using html_table 

```{r}
# subset list of table nodes for items 3 & 4
fips_table <- webpage %>%
        html_nodes("#mw-content-text") %>% html_table() %>% .[[1]]
        
head(fips_table)
```

### Data Cleaning for fips_df:

### Renaming the columns

```{r}
fips_table <- fips_table %>% 
  rename(
    fips_code = X1,
    county = X2,
    state = X3
    )
head(fips_table)
```

### Removing the unwanted rows

```{r}

fips_table <- fips_table[-c(1, 2), ]

head(fips_table)
```

### Filtering the data for New Jersey

```{r}
fips_df <- filter(fips_table, state == "New Jersey")

head(fips_df)
```

### Removing the string 'county' from county column

```{r}
fips_df$county<-gsub(" County","",as.character(fips_df$county))

head(fips_df)
```

### Reading the raw NJ diabetes data from GitHub

```{r}
diabetes_df <- read_csv("https://raw.githubusercontent.com/uzmabb182/Data_607_Final_Project/main/diabetes.prev.csv")

head(diabetes_df)
```

### Data Cleaning for diabetes_df:

### Removing the string  'county' from 'County'

```{r}
diabetes_df$County <-gsub(" County","",as.character(diabetes_df$County))

head(diabetes_df)
```

```{r}
diabetes_df <- filter(diabetes_df, State == "New Jersey")
head(diabetes_df)
```

### Renaming column name

```{r}
diabetes_df <- diabetes_df %>%
  rename(fips_code = FIPS.Codes
         )
head(diabetes_df)
```

### Making column names to lowercase

```{r}
names(diabetes_df) <- tolower(names(diabetes_df))    # Convert colnames to lower case
head(diabetes_df)
```



### Now joining Census dataset to fipscode dataset

```{r}

merge_df1 = census_df %>% inner_join(fips_df,by="county")

str(merge_df1)
```

### #convert column 'fips_code' from character to numeric

```{r}

merge_df1$fips_code <- as.numeric(merge_df1$fips_code)

```

`
### Now joining merge_df1 to education dataset

```{r}

merge_df = merge_df1 %>% inner_join(diabetes_df,by="fips_code")

colnames(merge_df)
```

### Renaming column name

```{r}
merge_df <- merge_df %>%
  rename(county = county.x,
         state = state.x
         )
head(merge_df)
```

### Dropping 9:10 columns

```{r}

merge_df <- select(merge_df, -(9:10))
                           
colnames(merge_df)
```
```{r}
merge_df <- merge_df %>% relocate(fips_code, .before = county)
merge_df <- merge_df %>% relocate(state, .after = county)
head(merge_df)
```

