---
title: "Data 607 - Final Project"
output: html_document
---

### Project Proposal:

Source of motivation for the final project: Education and Socioeconomic Status

https://www.apa.org/pi/ses/resources/publications/education



Economic Research Service
U.S. DEPARTMENT OF AGRICULTURE:

https://www.ers.usda.gov/data-products/county-level-data-sets/download-data/

 
Web Scraping list of fips code: https://en.wikipedia.org/wiki/List_of_United_States_FIPS_codes_by_county


API Call to census five years data:

https://api.census.gov/data/2019/acs/acs1?get=NAME,B01001_001E&for=county:*

How to achieve the objective:

Find the correlation between economic conditions and health



### Importing Libraries

```{r}
library(tidycensus)
library(tidyverse)
library(dplyr)
library(plotly)
library(tidyr)
library(stringr)
library(rvest)
library(ggpubr)

```

### Preparing for API Call Census 2010 Data

```{r}
Sys.setenv(census_api_key = "f7ce5a76ddf2088c73fda9c0a87410995cebbffa")
Sys.getenv("census_api_key")
```


### Access the API key
### Save the Census API key in the environmental variable.

```{r}
#census_api_key("YOUR KEY GOES HERE", install = TRUE)
```


```{r}
Sys.getenv("census_api_key")
```

### Fetching Census Data for the year 2010

```{r}
# https://api.census.gov/data/2019/acs/acs1?get=NAME,B01001_001E&for=county:*

census_df <- get_acs(
  geography = "county",
  variables = c(population = "B01003_001E",
                median_age = "B01002_001E",
                household_income = "B19013_001E",
                per_capita_income = "B19301_001E",
                poverty_count = "B17001_002E",
                unemployment_count = "B23025_005E"
                ),
  output = "wide",
  year = 2020
)

head(census_df)

```

### Data Cleaning for census_df:
### Removing the string 'County' from NAME column

```{r}
#census_df$NAME<-gsub(" County, *","",as.character(census_df$NAME))
census_df <- census_df %>%
  separate(NAME, c("county", "state"), ",")
head(census_df)
```
### Removing string 'county'

```{r}
census_df$county<-gsub(" County","",as.character(census_df$county))

head(census_df)
```


### Renaming column name

```{r}
#census_df <- census_df %>%
 # rename(county = NAME
         #)
#head(census_df)
```

### Dropping null rows
```{r}
census_df <- na.omit(census_df) #  Remove NA
head(census_df)
```


### Selecting the column of interest

```{r}
census_df <- select(census_df, county, state, population, median_age, household_income, per_capita_income, poverty_count, unemployment_count)

str(census_df)
```


### Checking the working directory path and exporting data frame into a CSV file

```{r}
# Get working directory path
path <- getwd()

path

```


### Web Scraping Counties fips code


### Generate the html source code by calling the read_html function

```{r}

webpage <- read_html("https://en.wikipedia.org/wiki/List_of_United_States_FIPS_codes_by_county")

tbls <- html_nodes(webpage, "table")

head(tbls)
```

### Calling html_nodes function with CSS Selector and generating the table using html_table 

```{r}

fips_table <- webpage %>%
        html_nodes("#mw-content-text") %>% html_table() %>% .[[1]]
        
head(fips_table)
```

### Data Cleaning for fips_df:

### Renaming the columns

```{r}
fips_table <- fips_table %>% 
  rename(
    fips_code = X1,
    county = X2,
    state = X3
    )
head(fips_table)
```

### Removing the unwanted rows

```{r}

fips_df <- fips_table[-c(1, 2), ]

head(fips_df)
```

```{r}
fips_df <- na.omit(fips_df) # Method 1 - Remove NA
head(fips_df)
```

### Removing string 'county'

```{r}
fips_df$county<-gsub(" County","",as.character(fips_df$county))

head(fips_df)
```

### Filtering the data for New Jersey

```{r}
# fips_df <- filter(fips_table, state == "New Jersey")

# head(fips_df)
```

### Removing the string 'county' from county column

```{r}
# fips_df$county<-gsub(" County","",as.character(fips_df$county))

str(fips_df)
```


### Now joining fips_df to census dataset

```{r}
#merge_df <- merge(census_df, fips_df, by = c("county", "state"))  # Applying inner_join() function
#merge_df  
#merge_df <- census_df %>% inner_join(fips_df, by = "county")

#merge two data frames
#merge_df = merge(census_df, fips_df, by.x=c("county", "state"), by.y=c("county", "state"))
#merge_df <- merge(census_df, fips_df, by = c('county', 'state'))

# merge two data frames in r
# r merge data frames by multiple columns
#jointdataset <- merge(ChickWeight, LabResults, by = c('Diet','Time'))
head(merge_df)
```


```{r}
education_df <- read_csv("https://raw.githubusercontent.com/uzmabb182/Data_607_Final_Project/main/ers_usda_education.csv")

head(education_df)
```

```{r}
#colnames(education_df)

```

```{r}
education_df <- education_df[-c(2:40)]
education_df <- education_df[-c(1),]

head(education_df)
```

```{r}
education_df <- rename_with(education_df, ~ tolower(gsub(",", "", .x, fixed = TRUE)))
education_df <- rename_with(education_df, ~ tolower(gsub("'s", "", .x, fixed = TRUE)))
education_df <- rename_with(education_df, ~ tolower(gsub(" ", "_", .x, fixed = TRUE)))
education_df <- rename_with(education_df, ~ tolower(gsub("-", "_", .x, fixed = TRUE)))
head(education_df)
```

```{r}
education_df <- na.omit(education_df) # Method 1 - Remove NA
view(education_df)
```



```{r}
merge_df$fips_code <- as.integer(merge_df$fips_code) 
```


```{r}

#new_df <- fips_df %>% inner_join(education_df, by="fips_code")

head(new_df)
```

```{r}
new_df <- new_df %>% 
  relocate(fips_code, .before=county)
new_df <-new_df %>% 
  relocate(state, .after=county)
view(new_df)
```

### Building the Model:

To build a model for estimating unemployment_count based on the household_income + per_capita_income + poverty_count:

sales = b0 + b1*household_income + b2*per_capita_income + b3*poverty_count

Compute the model coefficients:

```{r}
model <- lm(unemployment_count ~ household_income + per_capita_income + poverty_count, data = census_df)
summary(model)
```

### Interpretation:

The first step in interpreting the multiple regression analysis is to examine the F-statistic and the associated p-value.

The p-value of 7.823e-09 is less than alpha=0.05, which is highly significant. This means that, at least, one of the predictor variables is significantly related to the outcome variable.

To see which predictor variables are significant, you can examine the coefficients table, which shows the estimate of regression beta coefficients and the associated t-statitic p-values:

```{r}
summary(model)$coefficient
```

The t-statistic evaluates whether or not there is significant association between the predictor and the outcome variable, that is whether the beta coefficient of the predictor is significantly different from zero.

And changing in poverty_count are significantly associated to changes in unemployment_count while changes in household_income, and  per_capita_income is not significantly associated with unemployment_count.

### The confidence interval of the model coefficient can be:

```{r}
confint(model)
```

### The error rate can be estimated by dividing the RSE by the mean outcome variable:

```{r}
sigma(model)/mean(census_df$unemployment_count)
```

### To compute multiple regression using all of the predictors in the dataset

```{r}
model <- lm(percent_of_adults_with_a_bachelor_degree_or_higher_2015_19 ~ household_income, data = new_df)
summary(model)
```

