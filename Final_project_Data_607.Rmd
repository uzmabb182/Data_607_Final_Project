---
title: "Data 607 - Final Project"
output: html_document
---

### Project Proposal:

Source of motivation for the final project: Education and Socioeconomic Status

https://www.apa.org/pi/ses/resources/publications/education



Economic Research Service
U.S. DEPARTMENT OF AGRICULTURE:

https://www.ers.usda.gov/data-products/county-level-data-sets/download-data/

 
Web Scraping list of fips code: https://en.wikipedia.org/wiki/List_of_United_States_FIPS_codes_by_county


API Call to census five years data:

https://api.census.gov/data/2019/acs/acs1?get=NAME,B01001_001E&for=county:*

How to achieve the objective:

Find the correlation between economic conditions and health


### Importing Libraries
Interactive plot with ggPredict() function included in ggiraphExtra package

```{r}
library(tidycensus)
library(tidyverse)
library(dplyr)
library(plotly)
library(tidyr)
library(stringr)
library(rvest)
library(ggpubr)
library(ggiraph)
library(ggiraphExtra)
library(plyr)
```



### Web Scraping Counties fips code


### Generate the html source code by calling the read_html function

```{r}

webpage <- read_html("https://en.wikipedia.org/wiki/List_of_United_States_FIPS_codes_by_county")

tbls <- html_nodes(webpage, "table")

head(tbls)
```

### Calling html_nodes function with CSS Selector and generating the table using html_table 

```{r}

fips_df <- webpage %>%
        html_nodes("#mw-content-text") %>% html_table() %>% .[[1]]
        
head(fips_df)
```

### Data Cleaning for fips_df:

### Renaming the columns

```{r}
fips_df <- fips_df %>% 
  dplyr::rename(
    fips_code = X1,
    county = X2,
    state = X3
    )
head(fips_df)
```


### Removing the unwanted rows

```{r}

fips_df <- fips_df[-c(1, 2), ]

head(fips_df)
```

```{r}
colnames(fips_df) 
```

```{r}
# Drop the columns of the dataframe
#select (fips_df,-c('.'))
```




```{r}
fips_df <- na.omit(fips_df) # Method 1 - Remove NA
head(fips_df)
```

### Removing string 'county'

```{r}
#fips_df$county<-gsub(" County","",as.character(fips_df$county))

head(fips_df)
```

```{r}
names(fips_df) <- tolower(names(fips_df))   
 
head(fips_df)
```



### Checking the working directory path and exporting data frame into a CSV file
```{r}
# Get working directory path
path <- getwd()

path

```

### Export file as csv to working directory. 

```{r}

write.csv(fips_df, file.path(path, "/posgresql/fips_data.csv"))

```

```{r}
fips_df$NAME = paste(fips_df$county, fips_df$state, sep=", ")
names(fips_df) <- tolower(names(fips_df))  
head(fips_df)
```

```{r}
#str(census_df)
str(fips_df)
```


### Preparing for API Call Census 2010 Data

```{r}
Sys.setenv(census_api_key = "f7ce5a76ddf2088c73fda9c0a87410995cebbffa")
Sys.getenv("census_api_key")
```


### Access the API key
### Save the Census API key in the environmental variable.

```{r}
#census_api_key("YOUR KEY GOES HERE", install = TRUE)
```


```{r}
Sys.getenv("census_api_key")
```

### Fetching Census Data for the year 2010

```{r}
# https://api.census.gov/data/2019/acs/acs1?get=NAME,B01001_001E&for=county:*

census_df <- get_acs(
  geography = "county",
  variables = c(population = "B01003_001E",
                median_age = "B01002_001E",
                household_income = "B19013_001E",
                per_capita_income = "B19301_001E",
                poverty_count = "B17001_002E",
                unemployment_count = "B23025_005E"
                ),
  output = "wide",
  year = 2020
)

head(census_df)

```


### Data Cleaning for census_df:



### Convert colnames to lower case

```{r}

names(census_df) <- tolower(names(census_df))   
 
head(census_df)
```


### Dropping null rows

```{r}
census_df <- na.omit(census_df) #  Remove NA
head(census_df)
```


### Selecting the column of interest

```{r}
census_df <- select(census_df, name, population, median_age, household_income, per_capita_income, poverty_count, unemployment_count)

str(census_df)
```

```{r}
#sort descending
census_df[order(-census_df$household_income), ]
```

```{r}
#df1 <- select(census_df, population, median_age, household_income, poverty_count, unemployment_count, state) 
# Specify data column
#aggregate(x= df1$household_income,     
            
         # Specify group indicator
         #by = list(df1$state),      
            
         # Specify function (i.e. mean)
         #FUN = mean)
```


### Visualize the Census data

```{r}

```


### Now joining fips_df to census dataset

```{r}
census_df <- inner_join(census_df, fips_df, by = "name") # Applying inner_join() function

head(census_df)
```

### Split the name into two

```{r}
#census_df %>% separate(name, c("county","state"), sep = " County,")
census_df <- select(census_df,-c(name))
```

### Removing name column

```{r}
colnames(census_df)<-gsub(".x","",colnames(census_df))
head(census_df)
```

### Removing string 'county' from column values

```{r}
census_df$county<-gsub(" County","",as.character(census_df$county))
head(census_df)
```


```{r}
# converting character type 
# column to numeric
census_df <- transform(census_df,
                             fips_code = as.numeric(fips_code))
```



### Checking the working directory path and exporting data frame into a CSV file

```{r}
# Get working directory path
path <- getwd()

path

```

### Export file as csv to working directory.  

```{r}

write.csv(census_df, file.path(path, "/posgresql/census_data.csv"))

```



```{r}
education_df <- read_csv("https://raw.githubusercontent.com/uzmabb182/Data_607_Final_Project/main/ers_usda_education.csv")

head(education_df)
```

```{r}
#colnames(education_df)

```

```{r}
education_df <- education_df[-c(2:40)]
education_df <- education_df[-c(1),]

head(education_df)
```

```{r}
education_df <- rename_with(education_df, ~ tolower(gsub(",", "", .x, fixed = TRUE)))
education_df <- rename_with(education_df, ~ tolower(gsub("'s", "", .x, fixed = TRUE)))
education_df <- rename_with(education_df, ~ tolower(gsub(" ", "_", .x, fixed = TRUE)))
education_df <- rename_with(education_df, ~ tolower(gsub("-", "_", .x, fixed = TRUE)))
head(education_df)
```

```{r}
education_df <- na.omit(education_df) # Method 1 - Remove NA
head(education_df)
```

```{r}
str(education_df)
```

### Checking the working directory path and exporting data frame into a CSV file

```{r}
# Get working directory path
path <- getwd()

path

```

### Export file as csv to working directory.

```{r}

write.csv(education_df, file.path(path, "/posgresql/education_data.csv"))

```



```{r}
census_df$fips_code <- as.integer(census_df$fips_code) 
education_df$fips_code <- as.integer(education_df$fips_code)
```


```{r}
str(census_df)
#str(education_df)

#dim(census_df)
#dim(education_df)

```


```{r}

new_df <- census_df %>% inner_join(education_df, by="fips_code")
       # Join by multiple columns

nrow(new_df)
```


```{r}
new_df <- new_df %>% 
  relocate(fips_code, .before=county)
new_df <-new_df %>% 
  relocate(state, .after=county)
head(new_df)
```


```{r}
new_df$name = paste(new_df$county, new_df$state, sep=", ")
new_df <- new_df %>% 
  relocate(name, .before=county)
head(new_df)
```


```{r}
new_df <- select(new_df, name, population, median_age, household_income, per_capita_income, poverty_count, unemployment_count, percent_of_adults_with_a_bachelor_degree_or_higher_2015_19)

head(new_df)
```

### To calculate the percentage of poverty_count and unemployment_count 

```{r}
new_df <- mutate(new_df, percent_poverty_rate = (poverty_count/population)*100)
new_df <- mutate(new_df, percent_unemployment_rate = (unemployment_count/population)*100)
head(new_df)
```



### Regression: 
Regression is a supervised learning algorithm which helps in determining how does one variable influence another variable.

Multiple linear regression is useful for modelling the relationship between a numeric or dependent variable (Y) and multiple explanatory or independent variable (X).

After merging fips code, census, and education data, we would like to analyze the 

### Building the Model:


To build a model for estimating bachelor_degree_or_higher_2015_19 based on the population + median_age + household_income + per_capita_income + poverty_count + unemployment_count

#### bachelor_degree_or_higher_2015_19 = b0 + b1*population + b2*median_age + b3*household_income + b4*per_capita_income + b5*poverty_count + b6*unemployment_count

Compute the model coefficients:

```{r}
model <- lm(percent_of_adults_with_a_bachelor_degree_or_higher_2015_19 ~ population + median_age + household_income + per_capita_income + percent_poverty_rate + percent_unemployment_rate, data = new_df)
summary(model)
```

The F-Test of overall significance in regression is a test of whether or not your linear regression model provides a better fit to a dataset than a model with no predictor variables. 

The F-Test of overall significance has the following two hypotheses:

Null hypothesis (H0) : The model with no predictor variables (also known as an intercept-only model) fits the data as well as your regression model.

Alternative hypothesis (HA) : Your regression model fits the data better than the intercept-only model.

### Interpretation:


The first step in interpreting the multiple regression analysis is to examine the F-statistic and the associated p-value.

The p-value of 7.823e-09 is less than alpha=0.05, which is highly significant. This means that, at least, one of the predictor variables is significantly related to the outcome variable.

To see which predictor variables are significant, you can examine the coefficients table, which shows the estimate of regression beta coefficients and the associated t-statitic p-values:

```{r}
summary(model)$coefficient
```

The t-statistic evaluates whether or not there is significant association between the predictor and the outcome variable, that is whether the beta coefficient of the predictor is significantly different from zero.

And changing in poverty_count are significantly associated to changes in unemployment_count while changes in household_income, and  per_capita_income is not significantly associated with unemployment_count.

### The confidence interval of the model coefficient can be:

```{r}
confint(model)
```

### The error rate can be estimated by dividing the RSE by the mean outcome variable:

```{r}
sigma(model)/mean(new_df$percent_of_adults_with_a_bachelor_degree_or_higher_2015_19)
```



```{r}

ggscatter(new_df, x = "percent_of_adults_with_a_bachelor_degree_or_higher_2015_19", y = "percent_poverty_rate", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "percent_of_adults_with_a_bachelor_degree_or_higher_2015_19", ylab = "percent_poverty_rate", col = "red")
```


```{r}

ggscatter(new_df, x = "percent_of_adults_with_a_bachelor_degree_or_higher_2015_19", y = "household_income", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "percent_of_adults_with_a_bachelor_degree_or_higher_2015_19", ylab = "household_income", col = "blue")
```

```{r}
ggplot(new_df,aes(y=household_income,x=percent_of_adults_with_a_bachelor_degree_or_higher_2015_19))+geom_point()+geom_smooth(method="lm")
```




